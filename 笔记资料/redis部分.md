# Redis相关笔记

## 五种数据结构及用法
### string
存储数据结构： int或者SDS（五种结构类型 sdshdr,根据值的长度去选择，sds保存了字符串的长度以及剩余空间）

用途：

- ip 过滤，使用incr/decr等原子操作 
- 短信验证，可定义超时时间
- namespace,命名空间
- 告警推送（两种算法进行校验都通过后才进行推送，并设置超时时间）
- 进度条
### list

双向链表，可以往两头添加元素，时间复杂度是O(1)。获取两边元素很快，中间元素很慢。

数据结构： 

- v3.2之前，linkedlist或者ziplist
- v3.2之后，quicklist,由linkedlist和ziplist结合合成，和hashmap结构类似，先定位quicklistnode位置，quicklistnode中还存储着ziplist(entry)或者quicklistLZF。

用途：

- 栈（后进先出）：lpush lpop
- 对列（先进先出）： lpush rpop
- 消息队列：lpush brpop(rpop指令的阻塞版本) 
### hash->map

数据结构： hash或者ziplist(数据量小的时候用)

用途：

- 可以用来取存储一些对象（例如可以用来修改用户属性）
### set（不允许重复的无序数据）

数据结构: intset或者hashtable

用途：

- 共同好友，共同爱好以及相义点（diff指令）
- 统计网站访问的ip

### sorted-set（有序集合）

数据结构：ziplist或者skiplist（跳跃链表，散列分level存储，查询复杂度O(logn)）+hashtable

用途：

- 根据点击量去排序热门文章
- 游戏的用户得分排行榜
- 告警排行

## 发布订阅功能
用作消息实时系统，例如：即时聊天和群聊功能。但是消息无法持久化。

## Redis数据过期的方式
1. passive way：当数据被访问的时候会去检测是否过期，如果过期，则将其删除。
2. active way： 每秒中执行10次下述操作

> ①随机从过期的数据中挑选出20个。
> 
> ②删除挑选出来的数据。
> 
> ③如果删除的数据超过过期总数的25%，则会继续执行①步骤。（超过25%就不用每秒钟检测10次了，直接4次回收处理完成）

## Redis持久化
两种方式都开启的话会优先从AOF备份中读取。RDB恢复数据比AOF要快，因为RDB记录的是内存结构，而AOF记录的是数据指令。

#### RDB：是一种快照的方式。当符合条件时，fork子进程，生成dunp.rdb快照文件。
1. 配置规则：save seconds changes（间隔期间数据有可能会丢失）
2. save（会阻塞来自客户端的请求 ）或者bgsave（异步save）
3. flushall 
4. 执行复制操作

#### AOF（Append Only File）实时日志
- 性能会有影响，写数据到内存的时候要序列化一部分到硬盘。	
- 数据大了之后会进行压缩重写

## Redis内存的回收策略
**利用采样的方式去淘汰。**

allkeys-lru:最少使用的被淘汰。

allkeys-random: 随机淘汰。

**从已经设置过期时间的keys中去选择**：

volatile-random: 随机淘汰即将过期的数据。

volatile-lru: 即将过期最少使用的被淘汰。

volatile-ttl: 将即将过期的淘汰。



## Redis单线程为什么效率很高
非阻塞IO和内存操作，单线程不会出现上下文切换的开销，但是只能用到一个核心。redis主要受内存和带宽的限制，所以client调用端尽量不要把key值定义很大，避免网卡数据拷贝到内存的开销。

## Redis集群
主从复制实现读写分离。

### 哨兵机制（Raft协议）
进行选举master。在一主多从的情况下，可以利用哨兵机制去选取主节点，为了保证哨兵的高可用，咱们也可以给哨兵做集群处理。
### RedisCluster 高性能集群，数据水平切片
hashtag：通过HashTag可以自己设定将同一类型的key映射到同一个实例上去。

分片迁移：增加一组主节点时，其他节点上的数据需要部分迁移到新的节点上面来，保持一个平衡。

## 缓存一致性
缓存与数据库更新的选择。不同的协议很难存在强一致性，只能保证最终一致性。

1. 先更新数据库，利用消息中间件保证缓存一定会失效。
2. 先更新缓存，利用中间件保证一定会写入数据库。

## 缓存雪崩与缓存穿透

### 缓存雪崩
1. 缓存大面积失效，访问全部打到数据库层，所以过期时间需要散列分布一下
2. 利用多级缓存
3. 缓存查询不到，对数据库访问进行加锁或者限流


### 缓存穿透

1. 不存在的查询赋值一个默认值，给定一个失效时间
2. 利用布隆过滤器
3. 设置key的规则，不符合规则的直接返回