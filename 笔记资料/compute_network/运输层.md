### 运输层协议

运输层有一个很重要的功能-----**复用**和**分用**

- 复用：不同的应用进程都能够使用同一个运输层协议传输数据。
- 分用：接收方的运输层能够在剥去报文首部后能够把数据投递给不同的应用进程。



![transport](http://images.hcyhj.cn/network/transport.png)

从上图可以看出网络层和运输层的明显区别。**网络层为主机之间提供逻辑通讯，而运输层为应用程序之间提供端到端的逻辑通讯**。



#### 运输层端口

运输层要想把数据报正确的传递到各个应用中，则给每个进程都分配一个唯一的标志符是很有必要的，这里使用**协议端口号**去解决这个问题。在各个运输层协议中，都会有**源端口**和**目的端口**这两个字段，方便数据交付到相应的应用程序中。

##### 服务器使用的端口

- 系统端口号：0~1023，特定应用程序的端口号，所有的用户都知道，例如FTP（21），TELNET（23），SMTP（25），DNS（53），HTTP（80），HTTPS（443）等等。
- 登记端口号：1024~49151，应用程序可以指定的端口。

##### 客户端使用的端口

数值为49152~65535，又叫**短暂端口号**，客户进程运行时动态选择的。当服务进程收到客户进程报文时，能够进行回传数据，通讯结束后，刚刚使用过的端口号就不复存在了，这个端口号就可以给其他客户进程使用。

### UDP

用户数据报协议（User Datagram Protocol）,是一条不可信的信道。在传输数据之前不需要提前建立连接。接收方在收到数据之后也不用给任何确认。

其特点是：

1. 无连接
2. 尽最大努力交付
3. 面向报文
4. 没有拥塞机制
5. 支持一对一、一对多、多对一、多对多的交互通讯
6. 首部开销小，只有8个字节，比TCP的20个字节首部要短



![udp](http://images.hcyhj.cn/network/udp.png)

12个字节的伪首部是用来进行校验的，它不会向下传送也不会向上递交，仅仅用来计算校验和。在接收方UDP发现报文中的目的端口不正确，就丢弃该报文，并通过IMCP协议发送“端口不可达”差错报文给发送方，这也是traceroute实现的原理。





### 可靠传输的原理

#### **自动重传请求ARQ**

Automatic Repeat Request

1. 无差错情况下正常传输。
2. 有差错情况下，由于在每次发送数据报都会启动一个超时计时器，并且给每个发送的数据报都会提供一个编号，这样方便重传某块数据报。
3. 服务端会根据编号进行重复数据的过滤。

上面这个协议简单，但是缺点是效率比较低，用简单的图片描述一下上面的流程：

![stop_arq](http://images.hcyhj.cn/network/stop_arq.png)

通道的利用率简单的计算是U=Td/(Td+RTT+Ta)，可以说信道在绝大部分时间都是出于空闲状态。

#### **连续ARQ协议**

![sequence_arq](http://images.hcyhj.cn/network/sequence_arq.png)

一次性对多个分组进行确认，然后一次性可以同时传递多个分组，这样通道的利用率就提高了。咱们在确认时只用返回连续的最大的序号即可，这样前面的都表示已接收。累计确认也有缺点：如果已经发送了5个分组，其中第3个分组丢失了，那么会重传后面3个分组，这样也会浪费信道的利用率。





### TCP

传输控制协议（Transport Control Protocol）,是一条全双工的可靠信道。在传输数据之前必须先建立连接，数据传送结束之后要释放连接。不提供广播或多播服务。

其特点是：

1. 面向连接的传输层协议
2. 每个TCP连接只能有两个端点
3. 可靠交付
4. 全双工通讯
5. 面向字节流

![tcp](http://images.hcyhj.cn/network/tcp.png)





##### TCP的连接

每个TCP的连接有两个**端点**，其端点也叫**套接字**。*套接字 socket = (IP地址：端口号)*，同一个IP地址可以有多个TCP连接，而同一个端口号也可以出现在多个不同的TCP连接中。



##### 滑动窗口

##### 流量控制

##### 拥塞机制



#### 连接管理

##### 连接的创建

![](http://images.hcyhj.cn/network/tcp-3.png)





##### 连接的释放

![](http://images.hcyhj.cn/network/tcp-4.png)



